#!/usr/bin/env bash

read -p "Are you sure you want uninstall php and all its extensions? [y/n] " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]
then
    echo "Cancelled."
    exit 0
fi

uninstall_php() {
    local PHP=$1

    echo -e "\nRemoving PHP $(php-current-version 'pretty')..."
    # brew remove $PHP
}

uninstall_extensions() {
    local PHP=$1

    local PHP_VERSION=$(php-current-version 'pretty')
    echo -e "\nRemoving extensions for PHP $PHP_VERSION..."

    local EXTENSIONS=$(brew list | grep "^$PHP-")

    IFS=' ' read -ra PLUGINS <<< ${EXTENSIONS//$'\n'/' '}
    local i; for i in "${PLUGINS[@]}"; do

        # remove extension
        # brew remove $i

        # a lil' cleanup
        local PLUGIN=`echo $i | cut -d - -f 2-`
        echo "/usr/local/etc/php/$PHP_VERSION/conf.d/ext-${PLUGIN}.ini"

    done
}

sanitize() {
    local PHP=${1-''}

    # exit if valid version is supplied
    if [[ ! -z $PHP ]]; then
        for i in ${ALL[@]}; do
            if [[ $i == $PHP ]]; then
                echo $PHP && return
            fi
        done
    fi

    echo $(php-installed)
}

IFS=' ' read -ra WHAT <<< $(sanitize ${1-''})
for i in "${WHAT[@]}"; do
    php-switch-osx $i > /dev/null
    uninstall_extensions $i
    uninstall_php $i
done

echo "All done!"
